# 工作流名称
name: Build and Push Docker Image

# 触发条件：
# 1. 推送到 main 分支；
# 2. 创建标签（如 v1.0.0）时触发；
on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

# 工作流权限（GHCR 推送需要）
permissions:
  packages: write  # 允许推送 GHCR 镜像
  contents: read   # 允许读取仓库代码

# 任务定义
jobs:
  build-and-push:
    # 运行环境：最新版 Ubuntu
    runs-on: ubuntu-latest
    steps:
      # 步骤 1：拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2：设置镜像标签（兼容分支和标签触发）
      - name: Set image tags
        id: set_tags
        run: |
          # 基础标签：仓库名:latest（分支触发）或 仓库名:标签（tag 触发）
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # 提取 tag 名称（如 v1.0.0 → 1.0.0）
            TAG=${GITHUB_REF#refs/tags/v}
            echo "tags=your-dockerhub-username/your-repo:$TAG,your-dockerhub-username/your-repo:latest,ghcr.io/your-github-username/your-repo:$TAG,ghcr.io/your-github-username/your-repo:latest" >> $GITHUB_OUTPUT
          else
            echo "tags=your-dockerhub-username/your-repo:latest,ghcr.io/your-github-username/your-repo:latest" >> $GITHUB_OUTPUT
          fi

      # 步骤 3：设置 Docker Buildx（增强构建能力，支持多平台）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤 4：登录 Docker Hub（如需推送 Docker Hub）
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKER_HUB_USERNAME }}
      #     password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 步骤 5：登录 GHCR（如需推送 GHCR）
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}  # 当前 GitHub 用户名
          password: ${{ secrets.GITHUB_TOKEN }}  # GitHub 自动生成的临时 Token

      # 步骤 6：构建并推送镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .  # 构建上下文（仓库根目录）
          push: true   # 启用推送
          tags: ${{ steps.set_tags.outputs.tags }}  # 使用步骤 2 生成的标签
          cache-from: type=gha  # 缓存加速（复用之前的构建层）
          cache-to: type=gha,mode=max